---
interface Props {
  tags: string[];
}

const { tags } = Astro.props;
---

{tags.length > 0 && (
  <div class="filter-bar" role="toolbar" aria-label="Filter by tag">
    <span class="filter-label">Filter:</span>
    <button class="filter-btn active" data-filter="all">All</button>
    {tags.map(tag => (
      <button class="filter-btn" data-filter={tag}>{tag}</button>
    ))}
    <div class="sort-wrapper">
      <label for="sort-select" class="sr-only">Sort by</label>
      <select id="sort-select" class="sort-select" data-sort>
        <option value="date-desc">Newest first</option>
        <option value="date-asc">Oldest first</option>
        <option value="title-asc">Title A-Z</option>
        <option value="title-desc">Title Z-A</option>
      </select>
    </div>
  </div>
)}

<script>
  function initFilters() {
    const buttons = document.querySelectorAll<HTMLButtonElement>('[data-filter]');
    const sortSelect = document.querySelector<HTMLSelectElement>('[data-sort]');
    const cards = document.querySelectorAll<HTMLElement>('.material-card');

    buttons.forEach(btn => {
      btn.addEventListener('click', () => {
        buttons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const filter = btn.dataset.filter;

        cards.forEach(card => {
          if (filter === 'all') {
            card.style.display = '';
            return;
          }
          const cardTags = card.querySelectorAll('[data-tag]');
          const match = Array.from(cardTags).some(t => t.getAttribute('data-tag') === filter);
          card.style.display = match ? '' : 'none';
        });
      });
    });

    sortSelect?.addEventListener('change', () => {
      const grid = document.querySelector('.material-grid');
      if (!grid) return;
      const items = Array.from(grid.children) as HTMLElement[];
      const [key, dir] = (sortSelect.value).split('-');

      items.sort((a, b) => {
        let aVal: string, bVal: string;
        if (key === 'date') {
          aVal = a.querySelector('time')?.getAttribute('datetime') ?? '';
          bVal = b.querySelector('time')?.getAttribute('datetime') ?? '';
        } else {
          aVal = a.querySelector('.card-title')?.textContent?.trim().toLowerCase() ?? '';
          bVal = b.querySelector('.card-title')?.textContent?.trim().toLowerCase() ?? '';
        }
        const cmp = aVal.localeCompare(bVal);
        return dir === 'asc' ? cmp : -cmp;
      });

      items.forEach(item => grid.appendChild(item));
    });
  }

  initFilters();
  document.addEventListener('astro:after-swap', initFilters);
</script>

<style>
  .filter-label {
    font-size: var(--font-size-sm);
    font-weight: 600;
    color: var(--color-text-secondary);
  }

  .sort-wrapper {
    margin-left: auto;
  }
</style>
