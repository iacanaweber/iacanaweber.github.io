---
import BaseLayout from '../layouts/BaseLayout.astro';
import CourseCard from '../components/CourseCard.astro';
import ProfileLinks from '../components/ProfileLinks.astro';
import { getCollection } from 'astro:content';
import { url } from '../utils/helpers';

const courses = (await getCollection('courses')).sort((a, b) => a.data.order - b.data.order);
const allNotes = await getCollection('notes', ({ data }) => !data.draft);
const allExercises = await getCollection('exercises', ({ data }) => !data.draft);
const allHomework = await getCollection('homework', ({ data }) => !data.draft);
const allTests = await getCollection('tests', ({ data }) => !data.draft);

const recentItems = [...allNotes, ...allExercises, ...allHomework, ...allTests]
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime())
  .slice(0, 5);

const allPubs = await getCollection('publications');
const recentPubs = allPubs
  .sort((a, b) => b.data.year - a.data.year || a.data.order - b.data.order)
  .slice(0, 3);

function getCourseTitle(courseSlug: string): string {
  return courses.find(c => c.slug === courseSlug)?.data.shortName ?? courseSlug;
}

function getMaterialTypeLabel(item: typeof recentItems[0]): string {
  if (allNotes.includes(item)) return 'Note';
  if (allExercises.includes(item)) return 'Exercise';
  if (allHomework.includes(item)) return 'Homework';
  return 'Test';
}

function getMaterialPath(item: typeof recentItems[0]): string {
  let type = 'notes';
  if (allExercises.includes(item)) type = 'exercises';
  else if (allHomework.includes(item)) type = 'homework';
  else if (allTests.includes(item)) type = 'tests';
  return url(`/courses/${item.data.course}/${type}/${item.slug}/`);
}

const researchInterests = [
  'Hardware Security',
  'SoC Design',
  'Cryptography',
  'Digital Systems',
  'Embedded Systems',
  'TRNG',
  'Side-Channel Attacks',
  'Fault Injection',
  'Post-Quantum Crypto',
  'HW/SW Co-Design',
];
---

<BaseLayout title="Iaçanã Ianiski Weber" description="Personal academic site — courses, publications, and research in hardware security, SoC design, and cryptography.">
  <div class="container page-content">
    <!-- Hero -->
    <section class="hero">
      <h1>Iaçanã Ianiski Weber</h1>
      <p class="hero-role" data-i18n="home.role1">Adjunct Professor — <a href="https://portal.pucrs.br/en/ensino/escola-politecnica/" target="_blank" rel="noopener">School of Technology</a>, PUCRS</p>
      <p class="hero-role" data-i18n="home.role2">Senior Systems Engineer — <a href="https://www.ensilica.com/" target="_blank" rel="noopener">EnSilica</a></p>

      <ProfileLinks inline={true} />
    </section>

    <!-- Research Interests -->
    <section class="home-section">
      <h2 data-i18n="home.researchInterests">Research Interests</h2>
      <div class="pill-grid">
        {researchInterests.map(interest => (
          <span class="pill">{interest}</span>
        ))}
      </div>
    </section>

    <!-- Courses -->
    <section class="home-section">
      <div class="section-header">
        <h2 data-i18n="home.courses">Courses</h2>
        <a href={url('/courses/')} class="see-all" data-i18n="home.seeAll">See all</a>
      </div>
      <div class="course-grid">
        {courses.map(course => (
          <CourseCard
            slug={course.slug}
            title={course.data.title}
            shortName={course.data.shortName}
            description={course.data.description}
            semester={course.data.semester}
            color={course.data.color}
          />
        ))}
      </div>
    </section>

    <!-- Recent Materials -->
    {recentItems.length > 0 && (
      <section class="home-section">
        <div class="section-header">
          <h2 data-i18n="home.recentMaterials">Recent Materials</h2>
          <a href={url('/courses/')} class="see-all" data-i18n="home.seeAll">See all</a>
        </div>
        <div class="recent-list">
          {recentItems.map(item => (
            <a href={getMaterialPath(item)} class="recent-item">
              <div class="recent-meta">
                <span class="tag">{getCourseTitle(item.data.course)}</span>
                <span class="recent-type">{getMaterialTypeLabel(item)}</span>
              </div>
              <h3>{item.data.title}</h3>
              <time datetime={item.data.date.toISOString()}>
                {item.data.date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' })}
              </time>
            </a>
          ))}
        </div>
      </section>
    )}

    <!-- Recent Publications -->
    {recentPubs.length > 0 && (
      <section class="home-section">
        <div class="section-header">
          <h2 data-i18n="home.recentPublications">Recent Publications</h2>
          <a href={url('/publications/')} class="see-all" data-i18n="home.seeAll">See all</a>
        </div>
        <div class="pub-list">
          {recentPubs.map(pub => (
            <div class="pub-entry">
              <p class="pub-citation">
                {pub.data.authors} ({pub.data.year}).
                <strong>{pub.data.title}</strong>.
                <em>{pub.data.venue}</em>.
                {pub.data.doi && (
                  <span> DOI: <a href={`https://doi.org/${pub.data.doi}`} target="_blank" rel="noopener">{pub.data.doi}</a></span>
                )}
              </p>
              {pub.data.url && (
                <a href={pub.data.url} target="_blank" rel="noopener" class="pub-link" data-i18n="publications.viewPaper">View Paper</a>
              )}
            </div>
          ))}
        </div>
      </section>
    )}
  </div>
</BaseLayout>

<style>
  .hero {
    text-align: center;
    padding: var(--space-12) 0 var(--space-8);
  }

  .hero h1 {
    font-size: clamp(2rem, 5vw, 3.5rem);
    margin-bottom: var(--space-2);
  }

  .hero-role {
    color: var(--color-text-secondary);
    font-size: var(--font-size-lg);
    margin: 0;
    line-height: 1.6;
  }

  .hero-role + .hero-role {
    margin-bottom: var(--space-4);
  }

  .home-section {
    margin-top: var(--space-12);
  }

  .section-header {
    display: flex;
    align-items: baseline;
    justify-content: space-between;
    margin-bottom: var(--space-6);
  }

  .section-header h2 {
    margin-bottom: 0;
  }

  .see-all {
    font-size: var(--font-size-sm);
    font-weight: 600;
    white-space: nowrap;
  }

  /* Research interest pills */
  .pill-grid {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-2);
  }

  .pill {
    display: inline-block;
    padding: var(--space-1) var(--space-3);
    background: var(--color-primary-light);
    color: var(--color-primary);
    border-radius: 9999px;
    font-size: var(--font-size-sm);
    font-weight: 600;
    white-space: nowrap;
  }

  /* Recent materials */
  .recent-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
  }

  .recent-item {
    display: block;
    padding: var(--space-4) var(--space-5);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    text-decoration: none;
    transition: all var(--transition-fast);
  }

  .recent-item:hover {
    border-color: var(--color-primary);
    box-shadow: var(--shadow-sm);
    text-decoration: none;
  }

  .recent-item h3 {
    font-size: var(--font-size-base);
    color: var(--color-text);
    margin-bottom: var(--space-1);
  }

  .recent-item time {
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
  }

  .recent-meta {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    margin-bottom: var(--space-2);
  }

  .recent-type {
    font-size: var(--font-size-xs);
    color: var(--color-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  /* Publications */
  .pub-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
  }

  .pub-entry {
    padding: var(--space-4) var(--space-5);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    background: var(--color-surface);
  }

  .pub-citation {
    margin-bottom: var(--space-2);
    line-height: 1.6;
  }

  .pub-citation em {
    color: var(--color-text-secondary);
  }

  .pub-link {
    display: inline-block;
    font-size: var(--font-size-sm);
    font-weight: 600;
  }
</style>
