---
import CourseLayout from '../../../layouts/CourseLayout.astro';
import { getCollection } from 'astro:content';
import { fetchSchedule } from '../../../utils/parseSchedule';
import type { GetStaticPaths } from 'astro';

export const getStaticPaths: GetStaticPaths = async () => {
  const courses = await getCollection('courses');
  return courses.map(course => ({
    params: { course: course.slug },
    props: { course },
  }));
};

const { course } = Astro.props;
const { Content } = await course.render();

// --- Schedule-first mode ---
const hasSchedule = !!course.data.scheduleUrl;
let scheduleEntries: Awaited<ReturnType<typeof fetchSchedule>>['entries'] = [];
let defaultRoom = '';

if (hasSchedule) {
  const result = await fetchSchedule(course.data.scheduleUrl!);
  scheduleEntries = result.entries;
  defaultRoom = result.defaultRoom;
}

// Load all resources for this course
const allResources = await getCollection('resources', ({ data }) => data.course === course.slug);

// General resources (no class) → collapsible section
const generalResources = allResources
  .filter(r => r.data.class == null)
  .sort((a, b) => a.data.order - b.data.order);

// ── Rowspan pre-processing ──────────────────────────────────────────────────
type Column = 'materiais' | 'exercicios' | 'extra';

function defaultColumn(type: string): Column {
  if (['slides', 'pdf', 'link'].includes(type)) return 'materiais';
  return 'extra';
}

function parseClassRange(val: string | number): { from: number; to: number } {
  const s = String(val);
  const parts = s.split('-').map(p => parseInt(p.trim(), 10));
  if (parts.length === 2 && !isNaN(parts[0]) && !isNaN(parts[1])) {
    return { from: Math.min(parts[0], parts[1]), to: Math.max(parts[0], parts[1]) };
  }
  const n = parseInt(s, 10);
  return { from: n, to: n };
}

interface CellData {
  resources: typeof allResources;
  rowspan: number;
  skip: boolean;
}

const cellMap = new Map<string, CellData>();

for (const r of allResources) {
  if (r.data.class == null) continue;
  const col: Column = (r.data.column as Column | undefined) ?? defaultColumn(r.data.type);
  const { from, to } = parseClassRange(r.data.class as string | number);

  const startKey = `${from}:${col}`;
  if (!cellMap.has(startKey)) {
    cellMap.set(startKey, { resources: [], rowspan: to - from + 1, skip: false });
  }
  const cell = cellMap.get(startKey)!;
  cell.resources.push(r);
  cell.rowspan = Math.max(cell.rowspan, to - from + 1);

  for (let c = from + 1; c <= to; c++) {
    const skipKey = `${c}:${col}`;
    if (!cellMap.has(skipKey)) {
      cellMap.set(skipKey, { resources: [], rowspan: 1, skip: true });
    }
  }
}

// Sort resources inside each cell by order
for (const cell of cellMap.values()) {
  cell.resources.sort((a, b) => a.data.order - b.data.order);
}

// Group general resources by type (for the collapsible Recursos section)
const generalResourcesByType: Record<string, typeof generalResources> = {};
for (const r of generalResources) {
  if (!generalResourcesByType[r.data.type]) generalResourcesByType[r.data.type] = [];
  generalResourcesByType[r.data.type].push(r);
}

// ── Helpers ─────────────────────────────────────────────────────────────────
function activityClass(activity: string): string {
  const a = activity.toLowerCase();
  if (a.includes('g2'))                                          return 'activity-g2';
  if (a.includes('substituição') || a.includes('substituicao')) return 'activity-sub';
  if (a.includes('prova') || a.includes('exame'))               return 'activity-exam';
  if (a.includes('trabalho'))                                    return 'activity-trabalho';
  if (a.includes('feriado'))                                     return 'activity-feriado';
  if (a.includes('evento') || a.includes('acadêmico') || a.includes('academico')) return 'activity-evento';
  return 'activity-class';
}

function dayLabel(abbr: string): string {
  const map: Record<string, string> = {
    SEG: 'Seg', TER: 'Ter', QUA: 'Qua', QUI: 'Qui',
    SEX: 'Sex', SAB: 'Sáb', DOM: 'Dom',
  };
  return map[abbr.toUpperCase()] ?? abbr;
}

function shortDate(date: string): string {
  const parts = date.split('/');
  return parts.length >= 2 ? `${parts[0]}/${parts[1]}` : date;
}

function resourceHref(r: (typeof allResources)[number]): string {
  return r.data.pdfPath ?? r.data.url ?? '#';
}

const COLUMNS: Column[] = ['materiais', 'exercicios', 'extra'];
const COL_LABELS: Record<Column, string> = {
  materiais: 'Materiais',
  exercicios: 'Exercícios',
  extra: 'Extra',
};

// Type label mapping for resource types
const typeLabels: Record<string, string> = {
  book: 'Livros', tool: 'Ferramentas', link: 'Links',
  video: 'Vídeos', slides: 'Slides', pdf: 'PDFs', other: 'Outros',
};
---

<CourseLayout
  title={course.data.title}
  courseSlug={course.slug}
  courseTitle={course.data.title}
  courseColor={course.data.color}
  currentSection="overview"
  description={course.data.description}
>
  <h1>{course.data.title}</h1>
  <p class="course-subtitle">
    <span class="course-badge" style={`background: ${course.data.color}`}>{course.data.shortName}</span>
    {course.data.semester}
  </p>

  {hasSchedule ? (
    <div class="schedule-view">

      {course.data.objectives && course.data.objectives.length > 0 && (
        <details class="collapsible-section">
          <summary>Objetivos da disciplina</summary>
          <ul>{course.data.objectives.map(obj => <li>{obj}</li>)}</ul>
        </details>
      )}

      {course.data.bibliography && course.data.bibliography.length > 0 && (
        <details class="collapsible-section">
          <summary>Bibliografia</summary>
          <ul>{course.data.bibliography.map(b => <li>{b}</li>)}</ul>
        </details>
      )}

      {generalResources.length > 0 && (
        <details class="collapsible-section">
          <summary>Recursos</summary>
          {Object.entries(generalResourcesByType).map(([type, items]) => (
            <div class="resource-group">
              <h4>{typeLabels[type] ?? type}</h4>
              <ul>
                {items.map(r => {
                  const href = r.data.pdfPath ?? r.data.url;
                  return (
                    <li>
                      {href
                        ? <a href={href} target="_blank" rel="noopener">{r.data.title}</a>
                        : r.data.title}
                      {r.data.description && <span class="res-desc"> — {r.data.description}</span>}
                    </li>
                  );
                })}
              </ul>
            </div>
          ))}
        </details>
      )}

      {scheduleEntries.length === 0 ? (
        <div class="schedule-unavailable">
          <p>Cronograma não disponível no momento.</p>
        </div>
      ) : (
        <div class="schedule-table-wrapper">
          <table class="schedule-table">
            <thead>
              <tr>
                <th class="col-num">#</th>
                <th class="col-date">Data</th>
                <th class="col-topic">Tópico</th>
                <th class="col-room">Sala</th>
                {COLUMNS.map(col => <th class={`col-${col}`}>{COL_LABELS[col]}</th>)}
              </tr>
            </thead>
            <tbody>
              {scheduleEntries.map(entry => {
                const room = entry.resources || defaultRoom || '—';
                const aClass = activityClass(entry.activity);
                return (
                  <tr class={`schedule-row ${aClass}`}>
                    <td class="col-num">{entry.number ?? '—'}</td>
                    <td class="col-date">
                      <span class="date-day">{dayLabel(entry.day)}</span>
                      <span class="date-num">{shortDate(entry.date)}</span>
                    </td>
                    <td class="col-topic">
                      <span class="topic-text">{entry.description || '—'}</span>
                      {aClass !== 'activity-class' && (
                        <span class={`activity-badge ${aClass}`}>{entry.activity}</span>
                      )}
                    </td>
                    <td class="col-room">{room}</td>
                    {COLUMNS.map(col => {
                      const key = `${entry.number}:${col}`;
                      const cell = cellMap.get(key) ?? { resources: [], rowspan: 1, skip: false };
                      if (cell.skip) return null;
                      return (
                        <td
                          rowspan={cell.rowspan > 1 ? cell.rowspan : undefined}
                          class={`col-${col}`}
                        >
                          {cell.resources.length > 0 && (
                            <div class="material-links">
                              {cell.resources.map(r => (
                                <a
                                  href={resourceHref(r)}
                                  class={`material-link type-${r.data.type}`}
                                  target="_blank"
                                  rel="noopener"
                                >
                                  {r.data.title}
                                </a>
                              ))}
                            </div>
                          )}
                        </td>
                      );
                    })}
                  </tr>
                );
              })}
            </tbody>
          </table>
        </div>
      )}
    </div>
  ) : (
    <div>
      {course.data.objectives && course.data.objectives.length > 0 && (
        <section class="overview-section">
          <h2>Objetivos</h2>
          <ul>{course.data.objectives.map(obj => <li>{obj}</li>)}</ul>
        </section>
      )}
      {course.data.bibliography && course.data.bibliography.length > 0 && (
        <section class="overview-section">
          <h2>Bibliografia</h2>
          <ul>{course.data.bibliography.map(book => <li>{book}</li>)}</ul>
        </section>
      )}
      <section class="overview-section prose">
        <Content />
      </section>
    </div>
  )}
</CourseLayout>

<style>
  .course-subtitle {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    color: var(--color-text-secondary);
    margin-bottom: var(--space-6);
  }

  .course-badge {
    display: inline-block;
    padding: var(--space-1) var(--space-3);
    font-size: var(--font-size-sm);
    font-weight: 700;
    color: #fff;
    border-radius: var(--radius-sm);
  }

  /* ── Overview layout ─────────────────────────────────────────────────── */
  .overview-section { margin-bottom: var(--space-8); }
  .overview-section h2 { border-top: none; margin-top: 0; padding-top: 0; }

  /* ── Collapsible sections ────────────────────────────────────────────── */
  .collapsible-section {
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    margin-bottom: var(--space-3);
    padding: var(--space-3) var(--space-4);
  }

  .collapsible-section summary {
    cursor: pointer;
    font-weight: 600;
    list-style: none;
    color: var(--color-text);
    user-select: none;
  }

  .collapsible-section summary::-webkit-details-marker { display: none; }
  .collapsible-section summary::before { content: '▸ '; color: var(--color-text-muted); }
  .collapsible-section[open] summary::before { content: '▾ '; }

  .collapsible-section ul { margin: var(--space-3) 0 0 var(--space-4); padding: 0; }

  .resource-group { margin-top: var(--space-3); }
  .resource-group h4 {
    font-size: var(--font-size-sm);
    font-weight: 600;
    color: var(--color-text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: var(--space-1);
  }
  .res-desc { color: var(--color-text-secondary); font-size: var(--font-size-sm); }

  /* ── Schedule table ──────────────────────────────────────────────────── */
  .schedule-unavailable {
    padding: var(--space-8);
    text-align: center;
    color: var(--color-text-secondary);
    border: 1px dashed var(--color-border);
    border-radius: var(--radius-md);
  }

  .schedule-table-wrapper { overflow-x: auto; margin-top: var(--space-4); }

  .schedule-table {
    width: 100%;
    border-collapse: collapse;
    font-size: var(--font-size-sm);
  }

  .schedule-table th {
    padding: var(--space-2) var(--space-3);
    text-align: left;
    font-weight: 600;
    background: var(--color-bg-secondary);
    border-bottom: 2px solid var(--color-border);
    white-space: nowrap;
    color: var(--color-text-secondary);
    font-size: var(--font-size-xs);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    /* override global td border */
    border: none;
    border-bottom: 2px solid var(--color-border);
  }

  .schedule-table td {
    padding: var(--space-2) var(--space-3);
    border: none;
    border-bottom: 1px solid var(--color-border);
    vertical-align: top;
  }

  /* Column widths */
  .col-num        { width: 2.5rem; text-align: center; color: var(--color-text-secondary); font-weight: 600; }
  .col-date       { width: 5rem; white-space: nowrap; }
  .col-room       { width: 6rem; white-space: nowrap; color: var(--color-text-secondary); }
  .col-materiais  { width: 11rem; }
  .col-exercicios { width: 10rem; }
  .col-extra      { width: 10rem; }

  /* Date cell */
  .date-day { display: block; font-weight: 600; font-size: var(--font-size-xs); color: var(--color-text-secondary); }
  .date-num { display: block; font-weight: 600; }

  /* Topic + badge */
  .topic-text { display: block; }
  .activity-badge {
    display: inline-block;
    margin-top: var(--space-1);
    padding: 1px var(--space-2);
    border-radius: var(--radius-sm);
    font-size: var(--font-size-xs);
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    color: #fff;
  }

  /* ── Row type colours — light theme ─────────────────────────────────── */
  .activity-class:hover td { background: var(--color-bg-secondary); }

  /* Prova — amber */
  .activity-exam td { background: #fffbeb; }
  .activity-exam .activity-badge { background: #d97706; }

  /* Prova de Substituição — orange */
  .activity-sub td { background: #fff7ed; }
  .activity-sub .activity-badge { background: #c2410c; }

  /* G2 — rose */
  .activity-g2 td { background: #fff1f2; }
  .activity-g2 .activity-badge { background: #be123c; }

  /* Trabalho — yellow */
  .activity-trabalho td { background: #fefce8; }
  .activity-trabalho .activity-badge { background: #ca8a04; }

  /* Feriado — salmon/red-orange */
  .activity-feriado td { background: #fff5f0; }
  .activity-feriado .activity-badge { background: #ea580c; }

  /* Evento Acadêmico — indigo/purple */
  .activity-evento td { background: #f5f3ff; }
  .activity-evento .activity-badge { background: #7c3aed; }

  /* ── Row type colours — dark theme ──────────────────────────────────── */
  /* :global() prevents Astro from adding the component scope hash to the
     [data-theme="dark"] selector (which lives on <html>, not in this component).
     Without it, Astro generates [data-theme="dark"][data-astro-cid-xxx] which
     never matches, so dark overrides are silently ignored. */

  :global([data-theme="dark"]) .activity-exam    td { background: #2d2200; }
  :global([data-theme="dark"]) .activity-exam    .activity-badge { background: #b45309; }

  :global([data-theme="dark"]) .activity-sub     td { background: #2d1800; }
  :global([data-theme="dark"]) .activity-sub     .activity-badge { background: #9a3412; }

  :global([data-theme="dark"]) .activity-g2      td { background: #2d0016; }
  :global([data-theme="dark"]) .activity-g2      .activity-badge { background: #9f1239; }

  :global([data-theme="dark"]) .activity-trabalho td { background: #2d2800; }
  :global([data-theme="dark"]) .activity-trabalho .activity-badge { background: #a16207; }

  :global([data-theme="dark"]) .activity-feriado  td { background: #2d1400; }
  :global([data-theme="dark"]) .activity-feriado  .activity-badge { background: #c2410c; }

  :global([data-theme="dark"]) .activity-evento   td { background: #1e1040; }
  :global([data-theme="dark"]) .activity-evento   .activity-badge { background: #6d28d9; }

  /* ── Material links ──────────────────────────────────────────────────── */
  .material-links { display: flex; flex-wrap: wrap; gap: var(--space-1); }

  .material-link {
    display: inline-block;
    padding: 2px var(--space-2);
    font-size: var(--font-size-xs);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    text-decoration: none;
    color: var(--color-primary);
    transition: all var(--transition-fast);
    white-space: nowrap;
  }

  .material-link:hover {
    background: var(--color-primary);
    color: #fff;
    border-color: var(--color-primary);
    text-decoration: none;
  }

  .material-link.type-pdf {
    border-color: #dc2626;
    color: #dc2626;
  }
  .material-link.type-pdf:hover {
    background: #dc2626;
    color: #fff;
    border-color: #dc2626;
  }
</style>
