---
import CourseLayout from '../../../../layouts/CourseLayout.astro';
import { getCollection } from 'astro:content';
import type { GetStaticPaths } from 'astro';

export const getStaticPaths: GetStaticPaths = async () => {
  const courses = await getCollection('courses');
  return courses.map(course => ({
    params: { course: course.slug },
    props: { course },
  }));
};

const { course } = Astro.props;

// Only show general resources (not linked to a specific class).
// Class-linked resources (slides, PDFs) appear in the schedule table instead.
const items = (await getCollection('resources', ({ data }) =>
  data.course === course.slug && data.class == null
)).sort((a, b) => a.data.order - b.data.order);

const typeLabels: Record<string, string> = {
  book:   'Livros',
  tool:   'Ferramentas',
  link:   'Links',
  video:  'Vídeos',
  slides: 'Slides',
  pdf:    'PDFs',
  other:  'Outros',
};

const grouped = items.reduce((acc, item) => {
  const type = item.data.type;
  if (!acc[type]) acc[type] = [];
  acc[type].push(item);
  return acc;
}, {} as Record<string, typeof items>);

// pdfPath (local file in public/) takes priority over url (external link)
function itemHref(item: (typeof items)[number]): string | undefined {
  return item.data.pdfPath ?? item.data.url;
}
---

<CourseLayout
  title="Recursos"
  courseSlug={course.slug}
  courseTitle={course.data.title}
  courseColor={course.data.color}
  currentSection="resources"
  description={`Recursos e referências para ${course.data.title}.`}
>
  <h1>Recursos</h1>
  <p style="color: var(--color-text-secondary); margin-bottom: var(--space-6);">
    Livros, ferramentas e links recomendados para a disciplina.
  </p>

  {Object.entries(grouped).length > 0 ? (
    Object.entries(grouped).map(([type, resources]) => (
      <section class="resource-section">
        <h2>{typeLabels[type] ?? type}</h2>
        <div class="resource-list">
          {resources.map(r => {
            const href = itemHref(r);
            return (
              <div class="resource-item card">
                <h3>
                  {href ? (
                    <a href={href} target="_blank" rel="noopener">{r.data.title}</a>
                  ) : (
                    r.data.title
                  )}
                  {r.data.pdfPath && <span class="local-badge">PDF local</span>}
                </h3>
                {r.data.description && <p>{r.data.description}</p>}
                {r.data.tags.length > 0 && (
                  <div class="tag-list">
                    {r.data.tags.map(tag => <span class="tag">{tag}</span>)}
                  </div>
                )}
              </div>
            );
          })}
        </div>
      </section>
    ))
  ) : (
    <p>Nenhum recurso listado ainda.</p>
  )}
</CourseLayout>

<style>
  .resource-section { margin-bottom: var(--space-8); }

  .resource-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
  }

  .resource-item h3 {
    font-size: var(--font-size-base);
    margin-bottom: var(--space-1);
    display: flex;
    align-items: center;
    gap: var(--space-2);
    flex-wrap: wrap;
  }

  .resource-item p {
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
    margin-bottom: var(--space-2);
  }

  .local-badge {
    font-size: var(--font-size-xs);
    font-weight: 600;
    padding: 1px var(--space-2);
    border-radius: var(--radius-sm);
    background: #fef3c7;
    color: #92400e;
    border: 1px solid #fde68a;
  }
</style>
